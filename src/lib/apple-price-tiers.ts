// Apple App Store allowed price tiers
// Source: https://developer.apple.com/app-store/pricing/

export const APPLE_PRICE_TIERS = [
  0.29, 0.39, 0.49, 0.59, 0.69, 0.79, 0.89, 0.90, 0.95, 0.99,
  1.00, 1.09, 1.19, 1.29, 1.39, 1.49, 1.59, 1.69, 1.79, 1.89,
  1.90, 1.95, 1.99, 2.00, 2.09, 2.19, 2.29, 2.39, 2.49, 2.59,
  2.69, 2.79, 2.89, 2.90, 2.95, 2.99, 3.00, 3.09, 3.19, 3.29,
  3.39, 3.49, 3.59, 3.69, 3.79, 3.89, 3.90, 3.95, 3.99, 4.00,
  4.09, 4.19, 4.29, 4.39, 4.49, 4.59, 4.69, 4.79, 4.89, 4.90,
  4.95, 4.99, 5.00, 5.09, 5.19, 5.29, 5.39, 5.49, 5.59, 5.69,
  5.79, 5.89, 5.90, 5.95, 5.99, 6.00, 6.09, 6.19, 6.29, 6.39,
  6.49, 6.59, 6.69, 6.79, 6.89, 6.90, 6.95, 6.99, 7.00, 7.09,
  7.19, 7.29, 7.39, 7.49, 7.59, 7.69, 7.79, 7.89, 7.90, 7.95,
  7.99, 8.00, 8.09, 8.19, 8.29, 8.39, 8.49, 8.59, 8.69, 8.79,
  8.89, 8.90, 8.95, 8.99, 9.00, 9.09, 9.19, 9.29, 9.39, 9.49,
  9.59, 9.69, 9.79, 9.89, 9.90, 9.95, 9.99, 10.00, 10.49, 10.90,
  10.95, 10.99, 11.00, 11.49, 11.90, 11.95, 11.99, 12.00, 12.49, 12.90,
  12.95, 12.99, 13.00, 13.49, 13.90, 13.95, 13.99, 14.00, 14.49, 14.90,
  14.95, 14.99, 15.00, 15.49, 15.90, 15.95, 15.99, 16.00, 16.49, 16.90,
  16.95, 16.99, 17.00, 17.49, 17.90, 17.95, 17.99, 18.00, 18.49, 18.90,
  18.95, 18.99, 19.00, 19.49, 19.90, 19.95, 19.99, 20.00, 20.49, 20.90,
  20.95, 20.99, 21.00, 21.49, 21.90, 21.95, 21.99, 22.00, 22.49, 22.90,
  22.95, 22.99, 23.00, 23.49, 23.90, 23.95, 23.99, 24.00, 24.49, 24.90,
  24.95, 24.99, 25.00, 25.49, 25.90, 25.95, 25.99, 26.00, 26.49, 26.90,
  26.95, 26.99, 27.00, 27.49, 27.90, 27.95, 27.99, 28.00, 28.49, 28.90,
  28.95, 28.99, 29.00, 29.49, 29.90, 29.95, 29.99, 30.00, 30.49, 30.90,
  30.95, 30.99, 31.00, 31.49, 31.90, 31.95, 31.99, 32.00, 32.49, 32.90,
  32.95, 32.99, 33.00, 33.49, 33.90, 33.95, 33.99, 34.00, 34.49, 34.90,
  34.95, 34.99, 35.00, 35.49, 35.90, 35.95, 35.99, 36.00, 36.49, 36.90,
  36.95, 36.99, 37.00, 37.49, 37.90, 37.95, 37.99, 38.00, 38.49, 38.90,
  38.95, 38.99, 39.00, 39.49, 39.90, 39.95, 39.99, 40.00, 40.49, 40.90,
  40.95, 40.99, 41.00, 41.49, 41.90, 41.95, 41.99, 42.00, 42.49, 42.90,
  42.95, 42.99, 43.00, 43.49, 43.90, 43.95, 43.99, 44.00, 44.49, 44.90,
  44.95, 44.99, 45.00, 45.49, 45.90, 45.95, 45.99, 46.00, 46.49, 46.90,
  46.95, 46.99, 47.00, 47.49, 47.90, 47.95, 47.99, 48.00, 48.49, 48.90,
  48.95, 48.99, 49.00, 49.49, 49.90, 49.95, 49.99, 50.00, 50.90, 50.99,
  51.00, 51.90, 51.99, 52.00, 52.90, 52.99, 53.00, 53.90, 53.99, 54.00,
  54.90, 54.99, 55.00, 55.90, 55.99, 56.00, 56.90, 56.99, 57.00, 57.90,
  57.99, 58.00, 58.90, 58.99, 59.00, 59.90, 59.99, 60.00, 60.90, 60.99,
  61.00, 61.90, 61.99, 62.00, 62.90, 62.99, 63.00, 63.90, 63.99, 64.00,
  64.90, 64.99, 65.00, 65.90, 65.99, 66.00, 66.90, 66.99, 67.00, 67.90,
  67.99, 68.00, 68.90, 68.99, 69.00, 69.90, 69.99, 70.00, 70.90, 70.99,
  71.00, 71.90, 71.99, 72.00, 72.90, 72.99, 73.00, 73.90, 73.99, 74.00,
  74.90, 74.99, 75.00, 75.90, 75.99, 76.00, 76.90, 76.99, 77.00, 77.90,
  77.99, 78.00, 78.90, 78.99, 79.00, 79.90, 79.99, 80.00, 80.90, 80.99,
  81.00, 81.90, 81.99, 82.00, 82.90, 82.99, 83.00, 83.90, 83.99, 84.00,
  84.90, 84.99, 85.00, 85.90, 85.99, 86.00, 86.90, 86.99, 87.00, 87.90,
  87.99, 88.00, 88.90, 88.99, 89.00, 89.90, 89.99, 90.00, 90.90, 90.99,
  91.00, 91.90, 91.99, 92.00, 92.90, 92.99, 93.00, 93.90, 93.99, 94.00,
  94.90, 94.99, 95.00, 95.90, 95.99, 96.00, 96.90, 96.99, 97.00, 97.90,
  97.99, 98.00, 98.90, 98.99, 99.00, 99.90, 99.99, 100.00, 100.99, 101.99,
  102.99, 103.99, 104.99, 105.99, 106.99, 107.99, 108.99, 109.00, 109.99, 110.99,
  111.99, 112.99, 113.99, 114.99, 115.99, 116.99, 117.99, 118.99, 119.00, 119.99,
  120.99, 121.99, 122.99, 123.99, 124.99, 125.99, 126.99, 127.99, 128.99, 129.00,
  129.99, 130.99, 131.99, 132.99, 133.99, 134.99, 135.99, 136.99, 137.99, 138.99,
  139.00, 139.99, 140.99, 141.99, 142.99, 143.99, 144.99, 145.99, 146.99, 147.99,
  148.99, 149.00, 149.99, 150.00, 150.99, 151.99, 152.99, 153.99, 154.99, 155.99,
  156.99, 157.99, 158.99, 159.00, 159.99, 160.99, 161.99, 162.99, 163.99, 164.99,
  165.99, 166.99, 167.99, 168.99, 169.00, 169.99, 170.99, 171.99, 172.99, 173.99,
  174.99, 175.99, 176.99, 177.99, 178.99, 179.00, 179.99, 180.99, 181.99, 182.99,
  183.99, 184.99, 185.99, 186.99, 187.99, 188.99, 189.00, 189.99, 190.00, 190.99,
  191.99, 192.99, 193.99, 194.99, 195.99, 196.99, 197.99, 198.99, 199.00, 199.99,
  200.00, 204.99, 209.00, 209.99, 214.99, 219.00, 219.99, 224.99, 229.00, 229.99,
  234.99, 239.00, 239.99, 244.99, 249.00, 249.99, 250.00, 254.99, 259.00, 259.99,
  264.99, 269.00, 269.99, 274.99, 279.00, 279.99, 284.99, 289.00, 289.99, 290.00,
  294.99, 299.00, 299.99, 300.00, 304.99, 309.00, 309.99, 314.99, 319.00, 319.99,
  324.99, 329.00, 329.99, 334.99, 339.00, 339.99, 344.99, 349.00, 349.99, 350.00,
  354.99, 359.00, 359.99, 364.99, 369.00, 369.99, 374.99, 379.00, 379.99, 384.99,
  389.00, 389.99, 390.00, 394.99, 399.00, 399.99, 400.00, 404.99, 409.00, 409.99,
  414.99, 419.00, 419.99, 424.99, 429.00, 429.99, 434.99, 439.00, 439.99, 444.99,
  449.00, 449.99, 450.00, 454.99, 459.00, 459.99, 464.99, 469.00, 469.99, 474.99,
  479.00, 479.99, 484.99, 489.00, 489.99, 490.00, 494.99, 499.00, 499.99, 500.00,
  509.00, 509.99, 519.00, 519.99, 529.00, 529.99, 539.00, 539.99, 549.00, 549.99,
  559.00, 559.99, 569.00, 569.99, 579.00, 579.99, 589.00, 589.99, 590.00, 599.00,
  599.99, 600.00, 609.00, 609.99, 619.00, 619.99, 629.00, 629.99, 639.00, 639.99,
  649.00, 649.99, 659.00, 659.99, 669.00, 669.99, 679.00, 679.99, 689.00, 689.99,
  690.00, 699.00, 699.99, 700.00, 709.00, 709.99, 719.00, 719.99, 729.00, 729.99,
  739.00, 739.99, 749.00, 749.99, 759.00, 759.99, 769.00, 769.99, 779.00, 779.99,
  789.00, 789.99, 790.00, 799.00, 799.99, 800.00, 809.00, 809.99, 819.00, 819.99,
  829.00, 829.99, 839.00, 839.99, 849.00, 849.99, 859.00, 859.99, 869.00, 869.99,
  879.00, 879.99, 889.00, 889.99, 890.00, 899.00, 899.99, 900.00, 909.00, 909.99,
  919.00, 919.99, 929.00, 929.99, 939.00, 939.99, 949.00, 949.99, 959.00, 959.99,
  969.00, 969.99, 979.00, 979.99, 989.00, 989.99, 990.00, 999.00, 999.99, 1000.00
];

export const APPLE_PRICE_TIERS_CENTS = APPLE_PRICE_TIERS.map(price => Math.round(price * 100));

export interface ExperimentArm {
  price_cents: number;
  quantity: number;
  name: string;
  reasoning: string;
}

export interface ExperimentHypothesis {
  hypothesis: string;
  reasoning: string;
  recommended_arms: ExperimentArm[];
  expected_winner: string;
  test_duration_days: number;
}

/**
 * Find the closest Apple-allowed price to a target price in cents
 */
export function findClosestApplePrice(targetCents: number): number {
  let closest = APPLE_PRICE_TIERS_CENTS[0];
  let minDiff = Math.abs(targetCents - closest);

  for (const price of APPLE_PRICE_TIERS_CENTS) {
    const diff = Math.abs(targetCents - price);
    if (diff < minDiff) {
      minDiff = diff;
      closest = price;
    }
  }

  return closest;
}

/**
 * Get valid Apple price points within a range
 */
export function getApplePricesInRange(minCents: number, maxCents: number): number[] {
  return APPLE_PRICE_TIERS_CENTS.filter(price => price >= minCents && price <= maxCents);
}

/**
 * Generate strategic price points for A/B testing
 */
export function generateStrategicPricePoints(
  basePriceCents: number,
  minPriceCents?: number,
  maxPriceCents?: number,
  numVariants: number = 4
): number[] {
  const min = minPriceCents || Math.max(29, Math.round(basePriceCents * 0.7));
  const max = maxPriceCents || Math.round(basePriceCents * 1.5);
  
  const availablePrices = getApplePricesInRange(min, max);
  
  if (availablePrices.length <= numVariants) {
    return availablePrices;
  }

  // Always include the closest price to the base price
  const basePrice = findClosestApplePrice(basePriceCents);
  const selectedPrices = [basePrice];

  // Add strategic price points
  const remaining = availablePrices.filter(p => p !== basePrice);
  const step = Math.floor(remaining.length / (numVariants - 1));
  
  for (let i = 0; i < numVariants - 1 && i * step < remaining.length; i++) {
    selectedPrices.push(remaining[i * step]);
  }

  return selectedPrices.sort((a, b) => a - b);
}